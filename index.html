<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Nova Reserva ‚Ä¢ Mercatto Del√≠cia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#eef3f8; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --brand-2:#1e40af; --ok:#16a34a; --warn:#b45309; --danger:#ef4444;
      --radius:14px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1115; --card:#12161c; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; }
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); padding:28px}
    .wrap{max-width:960px; margin:auto}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; gap:12px}
    .title{font-size:clamp(1.2rem,2.8vw,1.8rem); font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .badge{font-size:.8rem; background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff; padding:6px 10px; border-radius:999px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 5px 20px rgba(0,0,0,.06)}
    form{padding:24px}
    .section{border-top:1px dashed var(--line); padding-top:18px; margin-top:18px}
    .section:first-of-type{border-top:0; padding-top:0; margin-top:0}
    .section h3{margin:0 0 10px; font-size:1rem; color:var(--muted); font-weight:700; letter-spacing:.3px}
    label{font-weight:600; font-size:.94rem}
    .grid{display:grid; gap:14px}
    .g-2{grid-template-columns:1fr}
    .g-3{grid-template-columns:1fr}
    @media (min-width:720px){ .g-2{grid-template-columns:1fr 1fr} .g-3{grid-template-columns:1fr 1fr 1fr} }
    input, select, textarea, button{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:transparent; color:inherit; font-size:16px; outline:none; transition:.15s;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
    textarea{min-height:90px; resize:vertical}
    .hint{font-size:.82rem; color:var(--muted)}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:0; cursor:pointer; font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff}
    .btn-ghost{background:#0000; border:1px dashed var(--line)}
    .btn-danger{background:var(--danger); color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .row{display:flex; align-items:center; gap:10px}
    .chip{border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:.84rem; color:var(--muted)}
    .spinner{display:none; margin-top:10px; color:var(--muted)}
    .spinner.show{display:block}
    .file-box{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px dashed var(--line); border-radius:12px}
    .file-name{font-size:.9rem; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .toast{position:fixed; inset:auto 16px 16px auto; background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); display:none; z-index:50}
    .toast.show{display:block}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .dates-group{display:grid; gap:10px}
    .date-row{display:grid; grid-template-columns:1fr auto; gap:10px}
    @media (max-width:480px){ .date-row{grid-template-columns:1fr} }
    .pill{font-size:.78rem; padding:4px 8px; border-radius:999px; background:#1112; color:#fff}
    .req{color:var(--danger); margin-left:4px}
    footer{padding:14px 24px 22px; border-top:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">üìÖ Reservas Mercatto Del√≠cia</div>
      <div class="badge">Nova Reserva</div>
    </header>

    <form id="reservaForm" class="card" novalidate>
      <!-- hidden para backend -->
      <input type="hidden" name="acao" value="cadastrar" />
      <input type="hidden" name="status" value="Pendente" />

      <!-- Dados do cliente -->
      <div class="section">
        <h3>üë§ Dados do Cliente</h3>
        <div class="grid g-2">
          <div>
            <label for="nome">Nome Completo <span class="req">*</span></label>
            <input id="nome" name="nome" type="text" autocomplete="name" required />
          </div>
          <div>
            <label for="email">E-mail <span class="req">*</span></label>
            <input id="email" name="email" type="email" autocomplete="email" required />
          </div>
          <div>
            <label for="telefone">Telefone (WhatsApp) <span class="req">*</span></label>
            <input id="telefone" name="telefone" type="tel" inputmode="numeric" placeholder="(99) 99999-9999" required />
            <div class="hint">Usaremos para confirma√ß√£o da reserva.</div>
          </div>
          <div>
            <label for="pessoas">Quantidade de Pessoas <span class="req">*</span></label>
            <input id="pessoas" name="pessoas" type="number" min="1" step="1" required />
          </div>
        </div>
      </div>

      <!-- Detalhes da reserva -->
      <div class="section">
        <h3>ü™ë Detalhes da Reserva</h3>
        <div class="grid g-2">
          <div>
            <label for="mesa">Local da Reserva <span class="req">*</span></label>
            <select id="mesa" name="mesa" required>
              <option value="">Selecione o local</option>
              <option>SALA VIP</option>
              <option>SALA VIP 2</option>
              <option>SACADA</option>
            </select>
          </div>
          <div>
            <label for="cardapio">Card√°pio</label>
            <select id="cardapio" name="cardapio">
              <option value="">Selecione</option>
              <option>Buffet B√°sico</option>
              <option>Buffet Premium</option>
              <option>Rod√≠zio</option>
              <option>√Ä la carte</option>
              <option>Outro</option>
            </select>
          </div>
        </div>

        <label>Data(s) e Hora(s) <span class="req">*</span></label>
        <div id="dates" class="dates-group">
          <!-- linhas din√¢micas de data -->
        </div>
        <div class="toolbar" style="margin-top:6px">
          <button type="button" id="addDate" class="btn btn-ghost">+ Adicionar outra data/hora</button>
        </div>
        <div class="hint">N√£o √© permitido escolher data passada.</div>
      </div>

      <!-- Pagamento -->
      <div class="section">
        <h3>üí≥ Pagamento / Sinal</h3>
        <div class="grid g-3">
          <div>
            <label for="valorEstimado">Valor Estimado (R$)</label>
            <input id="valorEstimado" name="valorEstimado" type="text" inputmode="decimal" placeholder="0,00" />
          </div>
          <div>
            <label for="pagamentoAntecipado">Pagamento Antecipado (R$)</label>
            <input id="pagamentoAntecipado" name="pagamentoAntecipado" type="text" inputmode="decimal" placeholder="0,00" />
          </div>
          <div>
            <label for="banco">Banco <span id="bancoReq" class="req" style="display:none">*</span></label>
            <select id="banco" name="banco">
              <option value="">Selecione</option>
              <option>SICREDI</option>
              <option>ITA√ö</option>
              <option>CR√âDITO POS</option>
              <option>D√âBITO POS</option>
            </select>
            <div class="hint">Obrigat√≥rio quando houver pagamento antecipado.</div>
          </div>
        </div>
      </div>

      <!-- Observa√ß√µes e arquivo -->
      <div class="section">
        <h3>üìù Observa√ß√µes & Comprovante</h3>
        <div class="grid g-2">
          <div>
            <label for="observacoes">Observa√ß√µes</label>
            <textarea id="observacoes" name="observacoes" rows="3" placeholder="Prefer√™ncias, restri√ß√µes, aniversariante, etc."></textarea>
          </div>
          <div>
            <label for="arquivo">Comprovante (PDF, JPG ou PNG)</label>
            <input id="arquivo" type="file" accept=".pdf,.jpg,.jpeg,.png" />
            <div class="file-box" id="fileBox" style="display:none; margin-top:8px">
              <div class="file-name" id="fileName">‚Äî</div>
              <button type="button" id="clearFile" class="btn btn-danger" style="width:auto">Remover</button>
            </div>
            <div class="hint">Tamanho m√°ximo 5 MB.</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row" style="justify-content:space-between">
          <div class="chip">Status inicial: <strong>Pendente</strong></div>
          <div class="chip">Envio seguro</div>
        </div>
      </div>

      <footer class="card">
        <div class="spinner" id="spinner">‚¨§ Enviando reserva...</div>
        <div class="toolbar" style="margin-left:auto">
          <button type="reset" class="btn btn-ghost">Limpar</button>
          <button type="submit" id="submitBtn" class="btn btn-primary">Enviar Reserva</button>
        </div>
      </footer>
    </form>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== utilidades ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const endpoint = "https://script.google.com/macros/s/AKfycbyEwDBfRr28pade5vW2wtvxNXVNTvaSCLqWiWlid_7HyFN7CmhXz4nclWLvNs8hSIwC/exec";

    // m√°scara BR para telefone e moeda
    const maskPhone = v => {
      const d = v.replace(/\D/g,'').slice(0,11);
      if(d.length <= 10) return d.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
      return d.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, "($1) $2-$3");
    };
    const formatBRL = v => {
      const only = v.replace(/[^\d]/g,'');
      const num = Number(only)/100;
      return isNaN(num) ? "" : num.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}).replace("R$ ","");
    };
    const parseBRL = v => {
      if(!v) return "";
      const only = v.replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.');
      return only; // string num√©rica "1234.56"
    };

    const toast = (msg, ms=3000) => {
      const el = $("#toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), ms);
    };

    const todayLocal = () => {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      return now.toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
    };

    // ====== datas din√¢micas ======
    const datesWrap = $("#dates");
    const addDateRow = (value="") => {
      const row = document.createElement("div");
      row.className = "date-row";
      row.innerHTML = `
        <input type="datetime-local" name="datahora[]" required min="${todayLocal()}" ${value ? `value="${value}"`: ""}>
        <button type="button" class="btn btn-ghost remove-date" aria-label="Remover data">Remover</button>
      `;
      datesWrap.appendChild(row);
      row.querySelector(".remove-date").addEventListener("click", () => {
        if($$(".date-row", datesWrap).length > 1){ row.remove(); }
        else toast("Pelo menos 1 data √© necess√°ria.");
      });
    };

    $("#addDate").addEventListener("click", ()=> addDateRow());
    // primeira linha de data
    addDateRow();

    // ====== refs de elementos ======
    const form = $("#reservaForm");
    const spinner = $("#spinner");
    const submitBtn = $("#submitBtn");
    const inputTelefone = $("#telefone");
    const inputValor = $("#valorEstimado");
    const inputSinal = $("#pagamentoAntecipado");
    const selectBanco = $("#banco");
    const bancoReq = $("#bancoReq");
    const inputArquivo = $("#arquivo");
    const fileBox = $("#fileBox");
    const fileName = $("#fileName");
    const clearFile = $("#clearFile");

    // m√°scaras
    inputTelefone.addEventListener("input", e => e.target.value = maskPhone(e.target.value));
    [inputValor, inputSinal].forEach(inp => {
      inp.addEventListener("input", e => e.target.value = formatBRL(e.target.value));
    });

    // obrigatoriedade do banco quando h√° sinal
    const toggleBancoRequired = () => {
      const v = (inputSinal.value || "").replace(/[^\d]/g,"");
      const has = Number(v) > 0;
      selectBanco.required = has;
      bancoReq.style.display = has ? "" : "none";
    };
    inputSinal.addEventListener("input", toggleBancoRequired);

    // arquivo: preview + valida√ß√£o
    inputArquivo.addEventListener("change", () => {
      const f = inputArquivo.files[0];
      if(!f){ fileBox.style.display="none"; return; }
      const okType = /pdf|jpg|jpeg|png/i.test(f.type) || /\.(pdf|jpg|jpeg|png)$/i.test(f.name);
      if(!okType){ toast("Tipo de arquivo inv√°lido. Use PDF, JPG ou PNG."); inputArquivo.value=""; return; }
      if(f.size > 5 * 1024 * 1024){ toast("Arquivo maior que 5 MB."); inputArquivo.value=""; return; }
      fileName.textContent = f.name + " ‚Ä¢ " + (f.size/1024/1024).toFixed(2) + " MB";
      fileBox.style.display = "flex";
    });
    clearFile.addEventListener("click", ()=>{ inputArquivo.value=""; fileBox.style.display="none"; });

    // helper: file -> base64
    const toBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    // valida√ß√µes extras
    const validateExtra = () => {
      const telDigits = inputTelefone.value.replace(/\D/g,"");
      if(telDigits.length < 10){ toast("Telefone incompleto."); inputTelefone.focus(); return false; }

      // checar datas futuras
      const now = new Date();
      const invalid = $$("input[name='datahora[]']").some(inp => {
        if(!inp.value) return true;
        const d = new Date(inp.value);
        return d < now;
      });
      if(invalid){ toast("H√° data/hora no passado. Ajuste antes de enviar."); return false; }

      // banco obrigat√≥rio se houver sinal
      const sinal = Number((inputSinal.value||"").replace(/[^\d]/g,""));
      if(sinal > 0 && !selectBanco.value){
        toast("Selecione o banco do pagamento antecipado.");
        selectBanco.focus();
        return false;
      }
      return true;
    };

    // envio
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if(!form.checkValidity()){ toast("Confira os campos obrigat√≥rios."); return; }
      if(!validateExtra()) return;

      // evitar duplo envio
      spinner.classList.add("show");
      submitBtn.disabled = true;

      // montar dados
      const fd = new FormData(form);
      // normalizar moedas para o backend (como "1234.56")
      if(inputValor.value) fd.set("valorEstimado", parseBRL(inputValor.value));
      if(inputSinal.value) fd.set("pagamentoAntecipado", parseBRL(inputSinal.value));

      // transformar em objeto simples (preservando datahora[])
      const dados = {};
      for (const [key, value] of fd.entries()) {
        if (key === "datahora[]") {
          if (!dados["datahora[]"]) dados["datahora[]"] = [];
          dados["datahora[]"].push(value);
        } else {
          dados[key] = value;
        }
      }

      // arquivo (opcional)
      const f = inputArquivo.files[0];
      if(f){
        try{
          const base64 = await toBase64(f);
          dados["arquivo"] = String(base64).split(',')[1];
          dados["nomeArquivo"] = f.name;
        }catch(err){
          console.error(err);
          toast("Falha ao ler o arquivo.");
        }
      }

      try{
        const res = await fetch(endpoint, {
          method: "POST",
          body: new URLSearchParams(dados)
        });
        const text = await res.text();
        const msg = text && text.trim() ? text.trim() : "Reserva enviada com sucesso!";
        toast("‚úÖ " + msg, 4000);

        // resumo amig√°vel
        const nomes = $("#nome").value;
        const mesa = $("#mesa").value || "‚Äî";
        const datas = $$("input[name='datahora[]']").map(i => new Date(i.value)).map(d =>
          d.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' })
        ).join(" | ");
        alert(
`RESUMO DA RESERVA
Cliente: ${nomes}
Local: ${mesa}
Datas: ${datas}
Pessoas: ${$("#pessoas").value}
Contato: ${$("#telefone").value}`
        );

        form.reset();
        fileBox.style.display="none";
        datesWrap.innerHTML = "";
        addDateRow();
        toggleBancoRequired();
      }catch(err){
        console.error(err);
        toast("‚ùå Erro ao enviar reserva.");
        alert("Erro ao enviar reserva. Verifique sua conex√£o e tente novamente.");
      }finally{
        spinner.classList.remove("show");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
