function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Reservas") || ss.insertSheet("Reservas");

  // Cria cabeçalho se necessário
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      "Data de Envio", "Nome", "Email", "Telefone", "Pessoas", "Mesa",
      "Data/Hora da Reserva", "Valor Estimado", "Antecipado", "Banco",
      "Cardápio", "Observações", "Comprovante Base64"
    ]);
  }

  const nome = e.parameter.nome || "";
  const email = e.parameter.email || "";
  const telefone = e.parameter.telefone || "";
  const pessoas = e.parameter.pessoas || "";
  const mesa = e.parameter.mesa || "";
  const valorEstimado = e.parameter.valorEstimado || "";
  const pagamentoAntecipado = e.parameter.pagamentoAntecipado || "";
  const banco = e.parameter.banco || "";
  const cardapio = e.parameter.cardapio || "";
  const observacoesOriginais = e.parameter.observacoes || "";
  const comprovante = e.parameter.arquivo || "";

  // Captura múltiplas datas corretamente
  let datas = e.parameter["datahora[]"] || e.parameters["datahora[]"];
  if (!datas) {
    datas = [];
  } else if (!Array.isArray(datas)) {
    datas = [datas];
  }

  const timestamp = new Date();

  datas.forEach((dataStr, index) => {
    let dataHora = new Date(dataStr);
    if (isNaN(dataHora.getTime())) {
      dataHora = ""; // evita salvar data inválida
    }

    // Se for a primeira linha, mantém todos os valores
    // Caso contrário, limpa os campos financeiros e marca como "COMPLEMENTO RESERVA"
    const isPrincipal = index === 0;

    const linha = [
      timestamp,
      nome,
      email,
      telefone,
      pessoas,
      mesa,
      dataHora,
      isPrincipal ? valorEstimado : "",
      isPrincipal ? pagamentoAntecipado : "",
      isPrincipal ? banco : "",
      cardapio,
      isPrincipal ? observacoesOriginais : "COMPLEMENTO RESERVA",
      isPrincipal ? comprovante : ""
    ];

    sheet.appendRow(linha);
  });

  return ContentService.createTextOutput("✅ Reserva registrada com sucesso.");
}
